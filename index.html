<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mota Dash TV – V2</title>

<style>
html,body{
  height:100%;
  margin:0;
  background:#05070c;
  color:#eaeaf0;
  font-family:Inter, Arial, sans-serif;
  overflow:hidden;
}

#app{
  position:fixed;
  inset:0;
  display:flex;
  flex-direction:column;
}

#header{
  padding:16px 20px 8px;
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
}

#title{
  font-size:22px;
  font-weight:700;
}

#meta{
  font-size:14px;
  opacity:.75;
}

#chart{
  flex:1;
}

#progressWrap{
  height:6px;
  background:rgba(255,255,255,.15);
}
#progress{
  height:100%;
  width:100%;
  background:#4f7cff;
  transform-origin:left;
  transform:scaleX(1);
}
</style>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body>
<div id="app">
  <div id="header">
    <div id="title">Carregando…</div>
    <div id="meta"></div>
  </div>

  <div id="chart"></div>

  <div id="progressWrap">
    <div id="progress"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQdQuoLLALTl3wLHHfrpuZAZkFybA4qRdGNExiE1tMT6LDJC2_j-fhS0Jzlv5NInYxbHaxNLI0CMggw/pub?gid=806509342&single=true&output=csv";

const INTERVAL = 30000;
const LAST_DAYS = 30;

/* ================= UTIL ================= */
function parseCSV(text){
  return text.trim().split("\n").map(r=>r.split(","));
}
function ptNum(v){
  if(!v) return null;
  if(v.includes("%")) return parseFloat(v.replace("%","").replace(".","").replace(",","."))/100;
  return parseFloat(v.replace(".","").replace(",","."));
}
function hms(v){
  if(!v) return null;
  const [h,m,s]=v.split(":").map(Number);
  return h*3600+m*60+s;
}
function dmy(v){
  const [d,m,y]=v.split("/");
  return new Date(y,m-1,d);
}
function fmt(d){
  return d.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"});
}

/* ================= DATA ================= */
let DATA=[];

async function loadData(){
  const r=await fetch(CSV_URL+"&_="+Date.now());
  const t=await r.text();
  const rows=parseCSV(t);
  const h=rows[0].map(x=>x.toLowerCase());

  const idx={
    date:h.indexOf("data"),
    parado:h.indexOf("parado"),
    func:h.indexOf("funcionando"),
    tc:h.indexOf("tc medio"),
    pecas:h.indexOf("pecas fabric."),
    util:h.indexOf("utilizacao de maquina"),
    ef:h.indexOf("eficiencia -5 dias media")
  };

  DATA=rows.slice(1).map(r=>({
    d:dmy(r[idx.date]),
    parado:hms(r[idx.parado]),
    func:hms(r[idx.func]),
    tc:hms(r[idx.tc]),
    pecas:ptNum(r[idx.pecas]),
    util:ptNum(r[idx.util])*100,
    ef:ptNum(r[idx.ef])*100
  })).filter(x=>x.d).slice(-LAST_DAYS);
}

/* ================= CHARTS ================= */
const charts=[
{
  title:"Utilização da Máquina (%)",
  option:()=>({
    yAxis:{max:100},
    series:[{
      type:"line",
      smooth:true,
      areaStyle:{opacity:.3},
      data:DATA.map(x=>x.util)
    }]
  })
},
{
  title:"Eficiência Média 5 dias (%)",
  option:()=>({
    yAxis:{max:100},
    series:[{
      type:"line",
      smooth:true,
      areaStyle:{opacity:.3},
      data:DATA.map(x=>x.ef)
    }]
  })
},
{
  title:"Peças Fabricadas por Dia",
  option:()=>({
    series:[{
      type:"bar",
      data:DATA.map(x=>x.pecas)
    }]
  })
},
{
  title:"Tempo de Ciclo Médio (s)",
  option:()=>({
    series:[{
      type:"line",
      smooth:true,
      data:DATA.map(x=>x.tc)
    }]
  })
},
{
  title:"Parado vs Funcionando (h)",
  option:()=>({
    legend:{},
    series:[
      {name:"Funcionando",type:"bar",stack:"t",data:DATA.map(x=>x.func/3600)},
      {name:"Parado",type:"bar",stack:"t",data:DATA.map(x=>x.parado/3600)}
    ]
  })
}
];

let idx=0, chart, start;

/* ================= PLAYER ================= */
function render(){
  const c=charts[idx];
  document.getElementById("title").textContent=c.title;
  document.getElementById("meta").textContent=`${idx+1}/${charts.length}`;

  chart.setOption({
    backgroundColor:"transparent",
    tooltip:{trigger:"axis"},
    grid:{left:50,right:20,top:30,bottom:40},
    xAxis:{
      type:"category",
      data:DATA.map(x=>fmt(x.d)),
      axisLine:{lineStyle:{color:"#666"}},
      axisLabel:{color:"#aaa"}
    },
    yAxis:{
      type:"value",
      axisLine:{show:false},
      splitLine:{lineStyle:{color:"rgba(255,255,255,.05)"}},
      axisLabel:{color:"#aaa"}
    },
    ...c.option()
  },true);

  start=performance.now();
}

function tick(t){
  const p=Math.max(0,1-(t-start)/INTERVAL);
  document.getElementById("progress").style.transform=`scaleX(${p})`;
  if(p<=0){
    idx=(idx+1)%charts.length;
    render();
  }
  requestAnimationFrame(tick);
}

/* ================= BOOT ================= */
(async()=>{
  await loadData();
  chart=echarts.init(document.getElementById("chart"));
  render();
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
