<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mota TV – JSON (Apps Script)</title>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;background:#0a0e19;color:#e8eaed;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden;}
    #app{position:fixed;inset:0;display:flex;flex-direction:column;}

    #header{
      padding:18px 22px;
      background:linear-gradient(135deg, rgba(15,23,42,0.95) 0%, rgba(30,41,59,0.92) 100%);
      border-bottom:1px solid rgba(255,255,255,0.08);
      box-shadow:0 4px 20px rgba(0,0,0,0.3);
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
    }
    #left h1{font-size:20px;line-height:1.1;font-weight:800;color:#f1f5f9;}
    #left .sub{margin-top:6px;font-size:12px;color:#94a3b8;}
    #right{display:flex;flex-direction:column;align-items:flex-end;gap:6px;}
    #badge{font-size:12px;color:#cbd5e1;background:rgba(15,23,42,0.9);border:1px solid rgba(255,255,255,0.1);padding:6px 10px;border-radius:999px;}
    #hint{font-size:12px;color:#94a3b8;}

    #content{flex:1;min-height:0;display:flex;gap:12px;padding:12px;}
    .panel{
      flex:1;min-width:0;
      background:linear-gradient(180deg, rgba(15,23,42,0.9) 0%, rgba(30,41,59,0.75) 100%);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
    }
    .panelHeader{
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:rgba(2,6,23,0.35);
    }
    .panelTitle{font-size:14px;font-weight:800;color:#f1f5f9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .panelMeta{font-size:12px;color:#94a3b8;white-space:nowrap;}
    .panelBody{flex:1;min-height:0;overflow:auto;padding:10px 12px;}

    table{width:100%;border-collapse:separate;border-spacing:0;}
    th,td{padding:10px 10px;text-align:left;font-size:12px;white-space:nowrap;}
    thead th{
      position:sticky;top:0;z-index:2;
      background:rgba(15,23,42,0.95);
      color:#cbd5e1;
      border-bottom:1px solid rgba(255,255,255,0.08);
      font-weight:800;
    }
    tbody td{
      border-bottom:1px solid rgba(255,255,255,0.05);
      color:#e8eaed;
    }
    tbody tr:hover td{background:rgba(59,130,246,0.07);}
    .muted{color:#94a3b8;}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(15,23,42,0.55);
      color:#cbd5e1;font-size:11px;
    }

    #footer{
      padding:10px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-top:1px solid rgba(255,255,255,0.06);
      background:rgba(2,6,23,0.35);
      color:#94a3b8;
      font-size:12px;
      gap:10px;
    }
    #statusDot{
      width:8px;height:8px;border-radius:50%;
      background:#22c55e;display:inline-block;margin-right:8px;
      box-shadow:0 0 0 4px rgba(34,197,94,0.12);
    }
    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(15,23,42,0.75);
      color:#e8eaed;
      padding:7px 10px;
      border-radius:10px;
      font-size:12px;
    }
    .btn:active{transform:scale(0.98);}
    .warn #statusDot{background:#f59e0b;box-shadow:0 0 0 4px rgba(245,158,11,0.14);}
    .bad #statusDot{background:#ef4444;box-shadow:0 0 0 4px rgba(239,68,68,0.14);}

    @media (max-width: 900px){
      #content{flex-direction:column;}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="header">
      <div id="left">
        <h1>Mota TV • Dados (Apps Script JSON)</h1>
        <div class="sub">Mostrando dados das 2 planilhas via Web App (sem CSV). Atualiza automaticamente.</div>
      </div>
      <div id="right">
        <div id="badge">Carregando…</div>
        <div id="hint">Teclas: R atualizar • (TV) só deixa rodando</div>
      </div>
    </div>

    <div id="content">
      <div class="panel">
        <div class="panelHeader">
          <div class="panelTitle" id="t1">Fonte 1</div>
          <div class="panelMeta" id="m1">…</div>
        </div>
        <div class="panelBody">
          <table id="table1">
            <thead>
              <tr>
                <th>Data</th>
                <th>Util (%)</th>
                <th>Ef 5d (%)</th>
                <th>Peças</th>
                <th>TC (s)</th>
                <th>Func (h)</th>
                <th>Parado (h)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="muted" id="e1" style="padding:8px 2px;display:none;"></div>
        </div>
      </div>

      <div class="panel">
        <div class="panelHeader">
          <div class="panelTitle" id="t2">Fonte 2</div>
          <div class="panelMeta" id="m2">…</div>
        </div>
        <div class="panelBody">
          <table id="table2">
            <thead>
              <tr>
                <th>Data</th>
                <th>Util (%)</th>
                <th>Ef 5d (%)</th>
                <th>Peças</th>
                <th>TC (s)</th>
                <th>Func (h)</th>
                <th>Parado (h)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="muted" id="e2" style="padding:8px 2px;display:none;"></div>
        </div>
      </div>
    </div>

    <div id="footer" class="">
      <div>
        <span id="statusDot"></span>
        <span id="statusText">Conectando…</span>
        <span class="muted" id="lastUpdate" style="margin-left:10px;"></span>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span class="pill" id="refreshInfo">Auto refresh: 60s</span>
        <button class="btn" id="refreshBtn">Atualizar agora</button>
      </div>
    </div>
  </div>

<script>
/**
 * CONFIG
 * - Coloque token se seu Web App exigir (recomendado).
 * - Se já estiver sem token, mantenha token: "".
 */
const CONFIG = {
  refreshMs: 60000, // 60s (bom pra TV Box)
  days: 20,
  sources: [
    {
      name: "TEST",
      url: "https://script.google.com/macros/s/AKfycbzbEO-JpjRMjJSf-xOlIU36EAKITXep3lZa5wzX_gb2DBauRdu8vdUpIknuQk-mF2SM/exec"
    },
    {
      name: "Planilha 2",
      url: "https://script.google.com/macros/s/AKfycbzbEO-JpjRMjJSf-xOlIU36EAKITXep3lZa5wzX_gb2DBSFJNDauRdu8vd/exec"
    }
  ],
  token: "" // <- se precisar: "SEU_TOKEN"
};

const DOM = {
  badge: document.getElementById("badge"),
  statusText: document.getElementById("statusText"),
  lastUpdate: document.getElementById("lastUpdate"),
  footer: document.getElementById("footer"),
  refreshInfo: document.getElementById("refreshInfo"),
  t1: document.getElementById("t1"),
  t2: document.getElementById("t2"),
  m1: document.getElementById("m1"),
  m2: document.getElementById("m2"),
  e1: document.getElementById("e1"),
  e2: document.getElementById("e2"),
  tb1: document.querySelector("#table1 tbody"),
  tb2: document.querySelector("#table2 tbody"),
  refreshBtn: document.getElementById("refreshBtn"),
};

DOM.refreshInfo.textContent = `Auto refresh: ${Math.round(CONFIG.refreshMs/1000)}s`;

function fmt(n, digits=0){
  if(n === null || n === undefined || n === "") return "";
  const num = Number(n);
  if(!Number.isFinite(num)) return "";
  const d = Math.max(0, digits);
  return num.toLocaleString("pt-BR", { minimumFractionDigits:d, maximumFractionDigits:d });
}
function fmtPct(n){ return (n==null) ? "" : `${fmt(n,2)}%`; }
function fmtInt(n){ return (n==null) ? "" : fmt(n,0); }
function fmtH(n){ return (n==null) ? "" : `${fmt(n,2)}h`; }
function setStatus(level, text){
  DOM.footer.classList.remove("warn","bad");
  if(level==="warn") DOM.footer.classList.add("warn");
  if(level==="bad") DOM.footer.classList.add("bad");
  DOM.statusText.textContent = text;
}
function setBadge(text){ DOM.badge.textContent = text; }

async function fetchJsonWithTimeout(url, timeoutMs=8000){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);

  try{
    const u = new URL(url);
    // params padrão
    u.searchParams.set("days", String(CONFIG.days));
    if(CONFIG.token) u.searchParams.set("token", CONFIG.token);
    // cache-bust leve (não agressivo)
    u.searchParams.set("_", String(Date.now()));

    const resp = await fetch(u.toString(), {
      cache: "no-store",
      signal: controller.signal,
      headers: { "Accept": "application/json,text/plain,*/*" }
    });
    if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const json = await resp.json();
    return json;
  } finally {
    clearTimeout(t);
  }
}

function renderTable(tbody, rows){
  tbody.innerHTML = "";
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.label || r.date || "")}</td>
      <td>${escapeHtml(fmtPct(r.util))}</td>
      <td>${escapeHtml(fmtPct(r.ef5))}</td>
      <td>${escapeHtml(fmtInt(r.pecas))}</td>
      <td>${escapeHtml(r.tc_s == null ? "" : `${fmtInt(r.tc_s)}s`)}</td>
      <td>${escapeHtml(fmtH(r.func_h))}</td>
      <td>${escapeHtml(fmtH(r.parado_h))}</td>
    `;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function metaText(json){
  const rows = Array.isArray(json?.rows) ? json.rows.length : 0;
  const up = json?.updatedAt ? json.updatedAt : "";
  return `${rows} linhas • ${CONFIG.days} dias${up ? " • " + up.replace("T"," ").replace("Z","") : ""}`;
}

async function loadAll(){
  setBadge("Atualizando…");
  setStatus("warn","Buscando dados…");

  const start = Date.now();
  let okCount = 0;

  // carrega em paralelo (melhor para TV Box do que sequencial longo)
  const promises = CONFIG.sources.map(s => fetchJsonWithTimeout(s.url).then(
    json => ({ ok:true, json }),
    err => ({ ok:false, err })
  ));

  const results = await Promise.all(promises);

  // Fonte 1
  {
    const r = results[0];
    DOM.t1.textContent = CONFIG.sources[0].name;
    if(r.ok && r.json && (r.json.ok === undefined || r.json.ok === true)){
      const rows = Array.isArray(r.json.rows) ? r.json.rows : [];
      renderTable(DOM.tb1, rows);
      DOM.m1.textContent = metaText(r.json);
      DOM.e1.style.display = "none";
      okCount++;
    } else {
      DOM.tb1.innerHTML = "";
      DOM.m1.textContent = "Erro";
      DOM.e1.style.display = "block";
      DOM.e1.textContent = `Falha: ${r.ok ? (r.json?.error || "formato inválido") : r.err?.message}`;
    }
  }

  // Fonte 2
  {
    const r = results[1];
    DOM.t2.textContent = CONFIG.sources[1].name;
    if(r.ok && r.json && (r.json.ok === undefined || r.json.ok === true)){
      const rows = Array.isArray(r.json.rows) ? r.json.rows : [];
      renderTable(DOM.tb2, rows);
      DOM.m2.textContent = metaText(r.json);
      DOM.e2.style.display = "none";
      okCount++;
    } else {
      DOM.tb2.innerHTML = "";
      DOM.m2.textContent = "Erro";
      DOM.e2.style.display = "block";
      DOM.e2.textContent = `Falha: ${r.ok ? (r.json?.error || "formato inválido") : r.err?.message}`;
    }
  }

  const ms = Date.now() - start;
  DOM.lastUpdate.textContent = `Última atualização: ${new Date().toLocaleString("pt-BR")} • ${ms}ms`;

  if(okCount === CONFIG.sources.length){
    setStatus("good","Ao vivo");
    setBadge("OK • 2/2 fontes");
  } else if(okCount > 0){
    setStatus("warn",`Parcial (${okCount}/${CONFIG.sources.length})`);
    setBadge(`Parcial • ${okCount}/${CONFIG.sources.length}`);
  } else {
    setStatus("bad","Offline");
    setBadge("Erro • 0/2 fontes");
  }
}

let timer = null;

function start(){
  loadAll().catch(err => {
    setStatus("bad","Erro geral");
    setBadge("Erro");
  });

  if(timer) clearInterval(timer);
  timer = setInterval(() => loadAll().catch(()=>{}), CONFIG.refreshMs);
}

DOM.refreshBtn.addEventListener("click", start);
window.addEventListener("keydown", (e) => {
  if(e.key.toLowerCase() === "r") start();
});

start();
</script>
</body>
</html>
